using UnityEngine;

[RequireComponent(typeof(CharacterMotor2D))]
public class JumpAbility : MonoBehaviour
{
    public JumpConfig cfg;

    CharacterMotor2D motor;
    float coyoteTimer, bufferTimer;
    bool jumpHeld;
    int remainingAirJumps;

    // 점프 높이 배수 반영
    Unit ownerUnit;

    void Awake()
    {
        motor = GetComponent<CharacterMotor2D>();
        ownerUnit = GetComponent<Unit>(); // 없으면 null 허용
        remainingAirJumps = cfg ? cfg.extraAirJumps : 0;
    }

    public void UpdateTimers(float dt)
    {
        if (motor.IsGrounded)
        {
            coyoteTimer = cfg.coyoteTime;
            remainingAirJumps = cfg.extraAirJumps;
        }
        else
        {
            coyoteTimer = Mathf.Max(0, coyoteTimer - dt);
        }
        bufferTimer = Mathf.Max(0, bufferTimer - dt);
    }

    public void OnJumpPressed() { bufferTimer = cfg.bufferTime; }
    public void OnJumpReleased() { jumpHeld = false; }

    public void TryConsume()
    {
        if (bufferTimer <= 0f) return;

        // 우선: 지상 점프
        if (coyoteTimer > 0f)
        {
            DoJump();
            bufferTimer = 0f; coyoteTimer = 0f;
            return;
        }

        // 공중 점프
        if (remainingAirJumps > 0)
        {
            DoJump();
            remainingAirJumps--;
            bufferTimer = 0f;
        }
    }

    void DoJump()
    {
        // Exhaustion으로 조정된 점프 높이 배수 적용
        float jumpMul = (ownerUnit != null) ? ownerUnit.JumpHeightMultiplier : 1f;
        float jumpH = Mathf.Max(0f, (cfg ? cfg.jumpHeight : 0f) * jumpMul);

        float v0 = Mathf.Sqrt(2f * Mathf.Abs(motor.Gravity) * jumpH);
        motor.AddVerticalVelocity(v0);
        jumpHeld = true;
    }

    public void Tick()
    {
        // 점프 컷: 상승 중 & 키 뗐으면 상승 속도 절반
        if (!jumpHeld && motor.Velocity.y > 0f)
            motor.AddVerticalVelocity(motor.Velocity.y * 0.5f);
    }
}
